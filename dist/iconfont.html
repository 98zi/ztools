<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="./images/logo.png" type="image/x-icon">
  <title>解析 iconfont 字体文件</title>
  <link rel="stylesheet" href="./element/index.css" />
  <link rel="stylesheet" href="./css/index.css" />
  <style>
  #iconfont .flex {
    display: flex;
    flex-wrap: wrap;
  }

  .list {
    display: flex;
    flex-wrap: wrap;
    margin-top: 20px;
  }

  .list .item {
    background: #e2e2e2;
    border-radius: 10px;
    margin-right: 20px;
    margin-bottom: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
    cursor: pointer;
    transition: all 0.1s linear;
  }

  .list .item:hover {
    background: #c0c0c0;
  }
</style>
</head>

<body>
  <div class="aside">
  <h1><a href="/">ztools</a></h1>
  <ul>
    <li><a href="./github-folder-download.html">GitHub 下载指定文件夹</a></li>
    <li><a href="./iconfont.html">解析 iconfont 字体文件</a></li>
    <li><a href="./timestamp.html">时间戳转换工具</a></li>
    <li><a href="./ip.html">获取 ip 地址</a></li>
  </ul>
  <div class="foot">
    <a href="https://github.com/98zi/ztools" target="_blank" title="github"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github-filled" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5.315 2.1c.791 -.113 1.9 .145 3.333 .966l.272 .161l.16 .1l.397 -.083a13.3 13.3 0 0 1 4.59 -.08l.456 .08l.396 .083l.161 -.1c1.385 -.84 2.487 -1.17 3.322 -1.148l.164 .008l.147 .017l.076 .014l.05 .011l.144 .047a1 1 0 0 1 .53 .514a5.2 5.2 0 0 1 .397 2.91l-.047 .267l-.046 .196l.123 .163c.574 .795 .93 1.728 1.03 2.707l.023 .295l.007 .272c0 3.855 -1.659 5.883 -4.644 6.68l-.245 .061l-.132 .029l.014 .161l.008 .157l.004 .365l-.002 .213l-.003 3.834a1 1 0 0 1 -.883 .993l-.117 .007h-6a1 1 0 0 1 -.993 -.883l-.007 -.117v-.734c-1.818 .26 -3.03 -.424 -4.11 -1.878l-.535 -.766c-.28 -.396 -.455 -.579 -.589 -.644l-.048 -.019a1 1 0 0 1 .564 -1.918c.642 .188 1.074 .568 1.57 1.239l.538 .769c.76 1.079 1.36 1.459 2.609 1.191l.001 -.678l-.018 -.168a5.03 5.03 0 0 1 -.021 -.824l.017 -.185l.019 -.12l-.108 -.024c-2.976 -.71 -4.703 -2.573 -4.875 -6.139l-.01 -.31l-.004 -.292a5.6 5.6 0 0 1 .908 -3.051l.152 -.222l.122 -.163l-.045 -.196a5.2 5.2 0 0 1 .145 -2.642l.1 -.282l.106 -.253a1 1 0 0 1 .529 -.514l.144 -.047l.154 -.03z" stroke-width="0" fill="currentColor" /></svg></a>
  </div>
</div> <!-- 侧边 -->

    <main>
      <h2>解析 iconfont 字体文件</h2>
      <div id="iconfont" v-cloak>
  <div class="flex">
    <el-button type="primary" v-if="iconList.length > 0" @click="copyType = copyType === 'value' ? 'name' : 'value'">复制
      {{ copyType }}</el-button>
    <el-button type="primary" v-if="iconList.length > 0" @click="reload">重新解析</el-button>
  </div>

  <section class="p-input-container" v-if="iconList.length === 0">
    <div class="line"></div>
    <div class="file-box">
      <div class="input-box" v-if="iconList.length === 0">
        <label>解析本地 ttf、woff、otf 文件</label>
        <input type="file" @change="getLocalTTF" accept=".ttf,.woff,.otf">
      </div>
    </div>
  </section>

  <section v-else>
    <p>点击模块即可复制对应数据。</p>
    <div class="list">
      <div class="item" v-for="item in iconList" @click="copyToClipboard(item[copyType])">
        <svg v-if="isSymbol" class="icon" aria-hidden="true" v-html="`<use xlink:href='${item.value}'></use>`"></svg>
        <div v-else class="iconfont" v-html="isCSS ? '' : item.show" :class="isCSS ? item.show : '' "></div>
        <div>{{item.name}}</div>
        <div>{{item.value}}</div>
      </div>
    </div>
  </section>

</div>
    </main>

    <script src="./js/vue.js"></script>
<script src="./js/jquery3.6.1.js"></script>
<script src="./element/index.js"></script>

<script>
  $(function () {
    var pathname = window.location.pathname;
    $('.aside ul a').each(function () {
      if ($(this).attr('href') == '.' + pathname) {
        $('.aside ul a').removeClass('active');
        $(this).addClass('active');
      }
    })
  })
</script> <!-- 公共 -->

      <script src="./js/opentype.min.js"></script>
      <script>
  new Vue({
    el: '#iconfont',

    data() {
      return {
        timeouter: 0, // 操作提示计时器
        copyType: 'value', // icon 复制类型
        bufferStr: null, // 字体编码内容
        isSymbol: false, // 是否 symbol 模式
        isCSS: false, // 是否 css 文件链接
        iconList: [], // icon 列表
      }
    },

    // 获取链接中携带的资源链接
    created() {
      const urlObj = new URL(location.href)
      const url = urlObj.searchParams.get('source')
      if (url) {
        this.url = decodeURIComponent(url)
        this.getURLFile()
      }
    },

    methods: {

      // ajax 请求
      ajax(options) {
        options = options || {};
        let xhr = new XMLHttpRequest();
        if (options.type === 'buffer') {
          xhr.responseType = 'arraybuffer';
        }

        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            let status = xhr.status;
            if (status >= 200 && status < 300) {
              console.log(xhr)
              options.success && options.success(xhr.response);
            } else {
              options.fail && options.fail(status);
            }
          }
        };

        xhr.open("GET", options.url, true);
        xhr.send(null);
      },

      // 获取在线文件
      getURLFile() {
        if (!this.url) {
          alert('请输入链接')
          return
        }

        const urlObj = new URL(location.href)
        urlObj.searchParams.set('source', encodeURIComponent(this.url))
        window.history.replaceState(null, '', urlObj.href)

        if (this.url.toLowerCase().indexOf('.ttf') !== -1) {
          this.getOnlineTTF()
        } else if (this.url.toLowerCase().indexOf('.css') !== -1) {
          this.getOnlineCSS()
        } else if (this.url.toLowerCase().indexOf('.js') !== -1) {
          this.getOnlineJS()
        }

      },

      // 解析本地 ttf 文件
      getLocalTTF(event) {
        // 解析文件内容
        let file = event.target.files[0]
        let reader = new FileReader();
        reader.readAsArrayBuffer(file);
        reader.onload = (evt) => { this.parseIcon(evt.target.result); }

        // base64 编码，动态加入 @font-face
        let readerBase64 = new FileReader();
        readerBase64.readAsDataURL(file)
        readerBase64.onload = (evt) => { this.setStyle(evt.target.result) }

      },

      // 解析在线 ttf 文件
      getOnlineTTF() {
        // 远程获取文件
        this.ajax({
          url: this.url,
          type: 'buffer',
          success: (params) => { this.parseIcon(params) }
        })

        this.setStyle(this.url)
      },

      // 解析 CSS 文件
      getOnlineCSS() {
        // 远程获取文件
        this.isCSS = true;
        this.ajax({
          url: this.url,
          success: (params) => {
            this.setStyle('', params)
            params.replace(/\.([^:^ ]+):[\s\S]+?content: "\\([^"]+)";/gi, (...item) => {
              this.iconList.push({
                show: item[1],
                name: item[1],
                value: `&#${item[2]};`,
              })
            })
          }
        })
      },

      // 解析 JS 文件
      getOnlineJS() {
        // 远程获取文件
        this.isSymbol = true;
        this.ajax({
          url: this.url,
          success: (params) => {
            let $script = document.createElement('script')
            $script.src = this.url
            document.body.append($script);
            // console.log(params)

            //id="iconexchange"
            params.replace(/id="([^"]+)"/gi, (...item) => {
              this.iconList.push({
                show: item[1].replace(/icon/, ''),
                name: item[1].replace(/icon/, ''),
                value: `#${item[1]}`,
              })
            })
          }
        })
      },

      // 打开所有副本
      showAll() {
        this.parseIcon(this.bufferStr, true)
      },

      // 解析 icon
      parseIcon(bufferStr, showAll) {
        this.bufferStr = bufferStr
        this.iconList = []
        let result = window.opentype.parse(this.bufferStr);
        for (let key in result.glyphs.glyphs) {
          let item = result.glyphs.glyphs[key]
          if (!item.unicode) {
          } else if (showAll) { // 是否显示所有 unicodes
            let valueStr = ''
            item.unicodes.forEach(unicode => valueStr += `${unicode};\n`)
            this.iconList.push({
              name: item.name,
              value: valueStr,
              show: `&#${item.unicode};`
            })
          } else {
            this.iconList.push({
              name: item.name,
              show: `&#${item.unicode};`,
              value: `&#${item.unicode};`
            })
          }
        }
        this.iconList.forEach(item => {
          item.value = item.value.replace(/&#([^;]+);/ig, (target, value) => {
            return `&#x${parseInt(value).toString(16)};`
          })
        })
      },

      // 添加 style
      setStyle(url, cssFile) {
        let $style = document.createElement('style')
        if (cssFile) {
          $style.innerHTML = cssFile
        } else {
          $style.innerHTML = `
          @font-face {
    font-family: 'iconfont';
    src: url('${url}') format('truetype');
  }
  .iconfont {
    font-family: "iconfont" !important;
    font-size: 24px;font-style: normal;
    -webkit-font-smoothing: antialiased;
    -webkit-text-stroke-width: 0.2px;
    -moz-osx-font-smoothing: grayscale;
  }`;
        }

        document.body.append($style);
      },

      // 拷贝剪切板
      copyToClipboard(content) {
        clearTimeout(this.timeouter)
        this.$message({
          message: `复制成功：${content}`,
          type: 'success'
        });
        

        if (!document.queryCommandSupported('copy')) {
          return false
        }

        let $input = document.createElement('input')
        $input.style.opacity = '0'
        $input.value = content
        document.body.appendChild($input)
        $input.select()

        const result = document.execCommand('copy')
        document.body.removeChild($input)
        $input = null

        return result
      },

      // 页面重新加载
      reload() {
        const urlObj = new URL(location.href)
        urlObj.searchParams.delete('source')
        location.href = urlObj.href
      }
    }
  })
</script>
</body>

</html>